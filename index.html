<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mailinblack ‚Ä¢ Recommandateur de Bundles v2.4</title>
  <style>
    :root{--bg:#0f1226;--card:#14183a;--ink:#eef1ff;--muted:#9aa3c7;--accent:#8b9bff;--good:#00d19a;--warn:#ffb547;--bad:#ff6b6b;--chip:#2a2f59;--chip-on:#3a4080;--border:#2a2f59;--shadow:0 10px 30px rgba(0,0,0,.35)}
    *{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#0b0e21,#0f1226);color:var(--ink);font:14px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:20px auto;padding:0 14px}
    h1{margin:0 0 6px;font-size:22px}
    h2{margin:0 0 10px;font-size:18px}
    .grid{display:grid;grid-template-columns:1.1fr 1fr;gap:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .inputs{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .inputs .full{grid-column:1/-1}
    label{display:block;margin:4px 0 6px;color:var(--muted);font-size:12px}
    select{width:100%;background:#111536;border:1px solid #2a2f59;color:var(--ink);padding:10px;border-radius:10px}

    /* Pills (pain points) */
    .row{display:flex;flex-wrap:wrap;gap:8px}
    .pill{display:inline-flex;gap:8px;align-items:center;cursor:pointer;border:1px solid #1f2450;background:var(--chip);padding:10px 12px;border-radius:12px;color:var(--ink);user-select:none;transition:transform .02s ease, background .15s ease, border-color .15s ease}
    .pill:active{transform:translateY(1px)}
    .pill[aria-pressed="true"]{background:var(--chip-on);border-color:var(--accent)}
    .pill:focus{outline:2px solid var(--accent);outline-offset:2px}

    .muted{color:var(--muted)}
    .btn{background:linear-gradient(180deg,#4b59ff,#7a86ff);border:none;color:white;font-weight:600;cursor:pointer;border-radius:10px;padding:10px 12px}
    .btn.secondary{background:#1a1f46;border:1px solid #2a3175;color:#c6cdff}
    .btn.ghost{background:transparent;border:1px dashed #3a4080;color:#c6cdff}
    .btn:active{transform:translateY(1px)}
    .split{display:flex;gap:8px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
    .kpi{background:var(--chip);border:1px solid var(--border);border-radius:14px;padding:10px;text-align:center}
    .kpi .val{font-weight:800;font-size:18px}
    .tags{display:flex;flex-wrap:wrap;gap:8px}
    .tag{background:#1a1f46;border:1px solid #2a3175;color:#c6cdff;border-radius:999px;padding:6px 10px;font-size:12px}
    .list{display:grid;gap:10px}
    .item{background:var(--chip);border:1px solid var(--border);border-radius:14px;padding:14px}
    .item h3{margin:0 0 6px;font-size:16px}
    .reasons{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .reason{font-size:12px;color:var(--muted);background:#141a3f;border:1px solid #2a3175;border-radius:999px;padding:3px 8px}
    .scorebar{height:9px;background:#10153a;border-radius:999px;border:1px solid #2a3175;overflow:hidden;margin-top:8px}
    .scorebar > span{display:block;height:100%;background:linear-gradient(90deg,#5dd9b6,#4b59ff);width:0%}
    .heat{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:8px}
    .cell{height:22px;border-radius:6px;background:#141a3f;border:1px solid #2a3175;position:relative}
    .cell::after{content:"";position:absolute;inset:0;border-radius:6px;background:linear-gradient(180deg,rgba(255,255,255,.08),transparent);opacity:.6}
    .cell[data-on="1"]{background:linear-gradient(180deg,rgba(93,217,182,.25),rgba(75,89,255,.15))}
    .hint{font-size:12px;color:var(--muted)}
    .footer{margin-top:20px;color:var(--muted);font-size:12px}
    .preset{display:flex;flex-wrap:wrap;gap:8px}
    .tests{margin-top:14px}
    .test{display:inline-block;border:1px solid #2a3175;background:#141a3f;color:#c6cdff;border-radius:999px;padding:6px 10px;margin:4px 6px}
    .test[data-pass="true"]{border-color:#2d7a6a;background:#0f2a26;color:#8fe1cf}
    .test[data-pass="false"]{border-color:#7a2d2d;background:#2a0f0f;color:#ffb3b3}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="margin-bottom:16px">
      <h1>üîÆ Recommandateur de Bundles ‚Äì Mailinblack v2.4</h1>
      <p class="muted">S√©lectionne le contexte client, clique sur <b>Recommander</b> et obtiens un bundle <i>expliqu√©</i> (scores, raisons, effort, incentives). Version d√©mo autonome ‚Äì pas de d√©pendances.</p>
    </div>

    <div class="grid">
      <!-- LEFT: FORM -->
      <div class="card">
        <h2>Contexte client</h2>
        <div class="inputs">
          <div>
            <label>Secteur</label>
            <select id="secteur">
              <option>Sant√©</option><option>Industrie</option><option>Finance</option><option>√âducation</option><option>Administration</option><option>Commerce</option><option>BTP</option><option>Transport</option><option>√ânergie</option><option>Autre</option>
            </select>
          </div>
          <div>
            <label>Taille de l'entreprise</label>
            <select id="taille">
              <option>1-10</option><option>11-50</option><option>51-100</option><option>101-250</option><option>250-1000</option><option>1000+</option>
            </select>
          </div>
          <div>
            <label>Maturit√© cyber</label>
            <select id="maturite"><option>Faible</option><option>Moyenne</option><option>√âlev√©e</option></select>
          </div>
          <div>
            <label>Budget</label>
            <select id="budget"><option>Faible</option><option>Moyen</option><option>√âlev√©</option></select>
          </div>
          <div>
            <label>Contraintes r√©glementaires</label>
            <select id="reg"><option>Non</option><option>Oui</option></select>
          </div>
          <div>
            <label>Multi-sites / Prestataires</label>
            <select id="multi"><option>Non</option><option>Oui</option></select>
          </div>
          <div class="full">
            <label>Pain points (s√©lection multiple)</label>
            <div class="row" id="pains"></div>
            <div class="hint">Astuce : clique pour (d√©)s√©lectionner. Espace/Entr√©e = clavier.</div>
          </div>
          <div class="full">
            <label>Filtrage mail existant</label>
            <select id="filtre"><option>Non</option><option>Oui</option></select>
          </div>
          <div class="full split">
            <button class="btn" id="run">‚ö° Recommander</button>
            <button class="btn secondary" id="reset">‚Üª R√©initialiser</button>
            <button class="btn ghost" id="copy">‚ßâ Copier la sortie</button>
          </div>
          <div class="full">
            <div class="preset">
              <button class="btn ghost" data-preset="sante-mid">Preset Sant√© 101‚Äì250</button>
              <button class="btn ghost" data-preset="industrie-pti">Preset Industrie 11‚Äì50</button>
              <button class="btn ghost" data-preset="public-large">Preset Administration 1000+</button>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: OUTPUT -->
      <div class="card">
        <h2>R√©sultats</h2>
        <div class="kpis">
          <div class="kpi"><div class="val" id="kBundle">‚Äì</div><div class="muted">Bundle cible</div></div>
          <div class="kpi"><div class="val" id="kEffort">‚Äì</div><div class="muted">Effort total</div></div>
          <div class="kpi"><div class="val" id="kConf">‚Äì</div><div class="muted">Confiance</div></div>
          <div class="kpi"><div class="val" id="kIncent">‚Äì</div><div class="muted">Incentives</div></div>
        </div>

        <h3 style="margin-top:14px">Produits recommand√©s</h3>
        <div class="tags" id="recos"></div>

        <h3 style="margin-top:14px">D√©tail des scores</h3>
        <div class="list" id="scores"></div>

        <div class="tests">
          <button class="btn secondary" id="runTests">üß™ Lancer les auto-tests</button>
          <div id="testsOut"></div>
        </div>
      </div>
    </div>

    <div class="footer">v2.4 ‚Äì Fix : CSS nettoy√©, pastilles cliquables accessibles, JS corrig√©. Logique : exclusivit√© Essential/Advanced, plafond par budget, gating par effort, Sikker conditionnel prestataires (1000+), for√ßages sensibilisation.</div>
  </div>

<script>
// ========= ENGINE (identique √† la version TS mais en JS pur) =========
const inArr=(arr,...vals)=>vals.some(v=>arr.includes(v));
const segOf=t=> (t==="1-10"||t==="11-50")?"1-50":(t==="51-100"||t==="101-250")?"51-250":(t==="250-1000")?"251-1000":"1000+";
const Effort={Essential:.5,Coach:.5,Sikker:1.0,Advanced:1.5,Academy:1.0};
const ThresholdEffort={"1-50":2.0,"51-250":3.0,"251-1000":3.5,"1000+":3.5};
const MaxProductsByBudget={"Faible":2,"Moyen":3,"√âlev√©":3};
const BundleTargetBySeg={"1-50":2,"51-250":3,"251-1000":3,"1000+":3};

function scoreEssential(c){let s=0,r=[];
  if(["1-10","11-50"].includes(c.tailleEntreprise)){s+=3;r.push("Taille‚â§50");}
  if(["BTP","Commerce","Transport","Industrie"].includes(c.secteur)){s+=2;r.push("Secteur volume");}
  if(c.maturiteCyber==="Faible"){s+=2;r.push("Maturit√© faible");}
  if(c.budget==="Faible"){s+=2;r.push("Budget faible");}
  if(inArr(c.painPoints,"Phishing","Fraude")){s+=1;r.push("Phishing/Fraude");}
  if(!c.multiSitesOuPrestataires){s+=1;r.push("Mono-site");}
  if(["101-250","250-1000","1000+"].includes(c.tailleEntreprise)){s-=3;r.push("‚â•101: sous-dimensionn√©");}
  if(c.maturiteCyber==="√âlev√©e"){s-=2;r.push("Maturit√© √©lev√©e");}
  if(c.contraintesReglementaires){s-=1;r.push("Contraintes");}
  if(c.contraintesReglementaires && ["51-100","101-250","250-1000","1000+"].includes(c.tailleEntreprise)){s-=2;r.push("R√©glementaire & ‚â•51");}
  if(c.filtrageMailExistant){s-=3;r.push("Filtrage existant");}
  const seg=segOf(c.tailleEntreprise); if(seg==="1-50") s+=1; if(seg==="251-1000") s-=1; if(seg==="1000+") s-=2;
  return {score:s,reasons:r};}

function scoreAdvanced(c){let s=0,r=[];
  if(["101-250","250-1000","1000+"].includes(c.tailleEntreprise)){s+=3;r.push("Taille mid/large");}
  if(["Sant√©","Finance","√âducation","Administration","√ânergie"].includes(c.secteur)){s+=3;r.push("Secteur critique");}
  if(c.contraintesReglementaires){s+=3;r.push("Contraintes");}
  if(c.maturiteCyber==="√âlev√©e"){s+=2;r.push("Maturit√© √©lev√©e");}
  if(inArr(c.painPoints,"Gouvernance","Ransomware")){s+=2;r.push("Gov/Ransomware");}
  if(c.multiSitesOuPrestataires){s+=1;r.push("Multi-sites");}
  if(["1-10","11-50"].includes(c.tailleEntreprise)){s-=3;r.push("‚â§50: surdimensionn√©");}
  if(c.budget==="Faible"){s-=2;r.push("Budget faible");}
  if(c.filtrageMailExistant){s-=3;r.push("Filtrage existant");}
  const seg=segOf(c.tailleEntreprise); if(seg==="51-250") s+=1; if(seg==="251-1000"||seg==="1000+") s+=2;
  if(c.secteur==="Finance"){s+=1;r.push("Finance:+1");}
  return {score:s,reasons:r};}

function scoreCoach(c){let s=0,r=[];
  if(inArr(c.painPoints,"Phishing","Fraude","Sensibilisation")){s+=3;r.push("Phishing/Fraude/Sensibilisation");}
  if(c.contraintesReglementaires){s+=3;r.push("Conformit√©");}
  if(["Sant√©","Finance","Administration","√âducation","Commerce","BTP"].includes(c.secteur)){s+=2;r.push("Secteur prioritaire");}
  if(["Moyenne","√âlev√©e"].includes(c.maturiteCyber)){s+=2;r.push("Maturit√© ok");}
  if(c.tailleEntreprise!=="1-10"){s+=1;r.push("‚â•11 employ√©s");}
  if(c.budget==="Moyen"){s+=1;r.push("Budget moyen");}
  if((c.secteur==="BTP"||c.secteur==="Commerce") && ["1-10","11-50"].includes(c.tailleEntreprise)){s+=1;r.push("PME terrain");}
  if(c.filtrageMailExistant){s+=1;r.push("Compl√©ment filtrage");}
  if(c.budget==="Faible" && c.tailleEntreprise==="1-10" && !c.contraintesReglementaires){s-=2;r.push("TPE budget faible");}
  const seg=segOf(c.tailleEntreprise); if(seg==="51-250"||seg==="251-1000") s+=1; if(["Sant√©","Administration","√âducation"].includes(c.secteur)) s+=1;
  return {score:s,reasons:r};}

function scoreSikker(c){let s=0,r=[];
  if(c.multiSitesOuPrestataires){s+=3;r.push("Multi-sites/Prestataires");}
  if(inArr(c.painPoints,"Acc√®s partag√©s","Rotation personnel")){s+=3;r.push("Acc√®s partag√©s/Rotation");}
  if(["Industrie","Commerce","BTP","√âducation","Transport"].includes(c.secteur)){s+=2;r.push("Secteur acc√®s partag√©s");}
  if(["1-10","11-50","51-100","101-250"].includes(c.tailleEntreprise)){s+=2;r.push("‚â§250: IAM light");}
  if(c.maturiteCyber==="Moyenne"){s+=1;r.push("Maturit√© moyenne");}
  if(c.budget==="Faible"){s-=1;r.push("Budget faible");}
  if(inArr(c.painPoints,"Gouvernance")){s+=1;r.push("Gouvernance");}
  if(c.tailleEntreprise==="1000+"){s-=2;r.push("1000+: IAM existant"); if(c.multiSitesOuPrestataires){s+=2;r.push("Prestataires: ok");}}
  const seg=segOf(c.tailleEntreprise); if(seg==="51-250"||seg==="251-1000") s+=2; if(seg==="1000+") s+=1;
  if(["Sant√©","Administration"].includes(c.secteur)){s+=1;r.push("Sant√©/Public:+1");}
  return {score:s,reasons:r};}

function scoreAcademy(c){let s=0,r=[];
  if(c.contraintesReglementaires){s+=3;r.push("Conformit√©");}
  if(["Finance","Sant√©","√âducation","Administration","√ânergie"].includes(c.secteur)){s+=3;r.push("Secteur r√©gul√©");}
  if(["Moyenne","√âlev√©e"].includes(c.maturiteCyber)){s+=2;r.push("Maturit√© ok");}
  if(!["1-10","11-50"].includes(c.tailleEntreprise)){s+=2;r.push("‚â•51 employ√©s");}
  if(inArr(c.painPoints,"Conformit√©","Sensibilisation")){s+=1;r.push("Conformit√©/Sensibilisation");}
  if(c.filtrageMailExistant){s+=1;r.push("Compl√©ment filtrage");}
  if(c.secteur==="√âducation"){s+=1;r.push("√âducation:+1");}
  if(c.tailleEntreprise==="1-10"){s-=2;r.push("TPE: chronophage");}
  if(c.budget==="Faible"){s-=2;r.push("Budget faible");}
  if((c.secteur==="BTP"||c.secteur==="Commerce") && ["1-10","11-50"].includes(c.tailleEntreprise)){s-=1;r.push("BTP/Commerce‚â§50");}
  const seg=segOf(c.tailleEntreprise); if(seg!=="1-50") s+=1; if(["Sant√©","Administration"].includes(c.secteur)) s+=1;
  return {score:s,reasons:r};}

function applyVerticalTweaks(S,R,c){
  if(["Sant√©","Administration"].includes(c.secteur)){S.Coach+=1;R.Coach.push("Vertical:+1 Coach");S.Academy+=1;R.Academy.push("Vertical:+1 Academy");S.Sikker+=1;R.Sikker.push("Vertical:+1 Sikker");}
  if(c.secteur==="Industrie"){S.Sikker+=2;R.Sikker.push("Industrie:+2");S.Coach+=1;R.Coach.push("Industrie:+1");}
  if(c.secteur==="Finance"){S.Advanced+=1;R.Advanced.push("Finance:+1");S.Coach+=1;R.Coach.push("Finance:+1");S.Academy+=1;R.Academy.push("Finance:+1");}
  if(c.secteur==="√âducation"){S.Academy+=1;R.Academy.push("√âducation:+1");S.Coach+=1;R.Coach.push("√âducation:+1");}
  if(c.secteur==="BTP"||c.secteur==="Commerce"){S.Academy-=1;R.Academy.push("BTP/Commerce:-1");S.Coach+=1;R.Coach.push("BTP/Commerce:+1");}
  if(c.secteur==="√ânergie"){S.Advanced+=1;R.Advanced.push("√ânergie:+1");S.Academy+=1;R.Academy.push("√ânergie:+1");}
}

function computeIncentives(c, produits){
  const seg=segOf(c.tailleEntreprise); const inc=[]; const has=p=>produits.includes(p);
  if(seg==="1-50" && has("Essential") && has("Coach")) inc.push("Sikker 3 mois off si souscription <30j");
  if((seg==="51-250"||seg==="251-1000") && produits.length>=3) inc.push("-10% global bundle");
  if(c.tailleEntreprise==="1000+" && has("Advanced") && has("Coach") && has("Academy")) inc.push("-8% multi-pays / -12% si ‚â•2000 licences");
  if(["Sant√©","√âducation"].includes(c.secteur)) inc.push("Academy 3 mois off (pilote)");
  if(c.filtrageMailExistant) inc.push("Coach + Academy √† -15% (compl√©ment filtrage)");
  return inc;
}

function scoreAndRecommend(input){
  const c={...input}; const seg=segOf(c.tailleEntreprise); const bundleTarget=BundleTargetBySeg[seg];
  let S={Essential:0,Advanced:0,Coach:0,Sikker:0,Academy:0};
  let R={Essential:[],Advanced:[],Coach:[],Sikker:[],Academy:[]};
  ({score:S.Essential,reasons:R.Essential}=scoreEssential(c));
  ({score:S.Advanced,reasons:R.Advanced}=scoreAdvanced(c));
  ({score:S.Coach,reasons:R.Coach}=scoreCoach(c));
  ({score:S.Sikker,reasons:R.Sikker}=scoreSikker(c));
  ({score:S.Academy,reasons:R.Academy}=scoreAcademy(c));
  applyVerticalTweaks(S,R,c);
  let candidates=Object.keys(S);
  if(c.filtrageMailExistant){
    candidates=candidates.filter(p=>!["Essential","Advanced"].includes(p));
    R.Essential.push("Retir√©: filtrage existant"); R.Advanced.push("Retir√©: filtrage existant");
  } else {
    if(S.Advanced>S.Essential){candidates=candidates.filter(p=>p!=="Essential");R.Essential.push("Retir√©: Advanced > Essential");}
    else {candidates=candidates.filter(p=>p!=="Advanced");R.Advanced.push("Retir√©: Essential ‚â• Advanced");}
  }
  const onlyHuman=c.painPoints.length>0 && c.painPoints.every(pp=>["Phishing","Fraude","Sensibilisation","Conformit√©"].includes(pp));
  if(onlyHuman){
    if(["1-10","11-50"].includes(c.tailleEntreprise)){
      if(!candidates.includes("Coach")) candidates.push("Coach"); R.Coach.push("Forc√©: Sensibilisation-only ‚â§50");
      if(c.contraintesReglementaires && !candidates.includes("Academy")){candidates.push("Academy"); R.Academy.push("Option: R√©glementaire ‚â§50");}
    } else {
      if(!candidates.includes("Coach")) candidates.push("Coach");
      if(!candidates.includes("Academy")) candidates.push("Academy");
      R.Coach.push("Forc√©: Sensibilisation-only ‚â•51"); R.Academy.push("Forc√©: Sensibilisation-only ‚â•51");
    }
  }
  const ranked=candidates.map(p=>({p,s:S[p]})).sort((a,b)=>b.s-a.s);
  // --- S√©lection initiale (scores > 0) ---
  let selected=ranked.filter(x=>x.s>0).map(x=>x.p);

  // Limites par budget
  let maxProducts=MaxProductsByBudget[c.budget];
  if(c.tailleEntreprise==="1000+" && c.contraintesReglementaires && c.budget==="√âlev√©") maxProducts=4;
  const need=Math.min(bundleTarget,maxProducts);
  selected=ranked.filter(x=>selected.includes(x.p)).slice(0,need).map(x=>x.p);

  // ‚úÖ Cas sp√©cial : le client a D√âJ√Ä un filtrage mail et vient pour formation/sensibilisation
  // Si apr√®s s√©lection il n'y a rien (scores ‚â§ 0), ensemencer avec Coach (+Academy si pertinent)
  if(c.filtrageMailExistant && selected.length===0){
    selected = ["Coach"];
    R.Coach.push("Forc√©: compl√©ment au filtrage existant");
    if((c.contraintesReglementaires || ["51-100","101-250","250-1000","1000+"].includes(c.tailleEntreprise)) && selected.length<need){
      selected.push("Academy");
      R.Academy.push("Forc√©: sensibilisation/conformit√© sans Protect");
    }
  }

  // üîí R√®gle business : si pas de filtrage existant ‚Üí TOUJOURS un Protect (Essential ou Advanced)
  const protectChoice = candidates.includes("Advanced") ? "Advanced" : (candidates.includes("Essential") ? "Essential" : null);
  if(!c.filtrageMailExistant && protectChoice){
    if(!selected.includes(protectChoice)){
      // Ajoute le Protect choisi en priorit√©
      selected = [protectChoice, ...selected.filter(p=>p!==protectChoice)];
      // Si on d√©passe le quota, on retire le plus faible NON-Protect
      if(selected.length>need){
        const nonProtectRanked = ranked.filter(r=>r.p!==protectChoice && selected.includes(r.p));
        if(nonProtectRanked.length){
          const worst = nonProtectRanked[nonProtectRanked.length-1].p; // plus faible score dans la s√©lection
          selected = selected.filter(p=>p!==worst);
          R[worst].push("Retir√©: priorit√© au Protect (pas de filtrage existant)");
        }
      }
      R[protectChoice].push("Forc√©: base Protect requise (pas de filtrage existant)");
    }
  }

  // Calcul effort et gating ‚Äî on √©vite de retirer Protect en premier
  const sumEff=ls=>ls.reduce((a,p)=>a+(Effort[p]||0),0);
  let effort=sumEff(selected), thr=ThresholdEffort[seg];
  if(effort>thr){
    // on ordonne par (score - effort), mais en pla√ßant le Protect choisi √† la fin (donc retir√© en dernier)
    const withDelta=selected
      .map(p=>({p,delta:S[p]-(Effort[p]||0)}))
      .sort((a,b)=>{
        const aProt=(p=>p==="Essential"||p==="Advanced")(a.p);
        const bProt=(p=>p==="Essential"||p==="Advanced")(b.p);
        // d'abord non-Protect par delta croissant
        if(aProt!==bProt) return aProt?1:-1;
        return a.delta-b.delta;
      });
    while(effort>thr && withDelta.length){
      const rm=withDelta.shift().p;
      // ne jamais retirer le Protect s'il est le dernier restant √† couvrir la r√®gle business
      if(!c.filtrageMailExistant && (rm==="Essential"||rm==="Advanced") && selected.some(p=>p!==rm && (p==="Essential"||p==="Advanced"))===false){
        // saute ce retrait, passe au suivant
        continue;
      }
      selected=selected.filter(p=>p!==rm); effort=sumEff(selected); R[rm].push("Retir√©: sur-effort");
    }
  }

  const topScores=ranked.map(r=>r.s); const top1=topScores[0]||0; const top2=topScores[1]||0; const gap=Math.max(0,Math.min(10,top1-top2));
  let confidence=Math.round(60*(gap/10)+40*(1-Math.min(1,(effort-thr>0?(effort-thr)/thr:0))));
  if(c.budget==="Faible" && selected.length>2) confidence-=10; confidence=Math.max(0,Math.min(100,confidence));
  const incentives=computeIncentives(c,selected);
  const labelMap={Essential:"Protect Essential",Advanced:"Protect Advanced",Coach:"Coach",Sikker:"Sikker",Academy:"Cyber Academy"};
  return {
    produitsRecommandes:selected.map(p=>labelMap[p]),
    bundleCible:BundleTargetBySeg[seg],
    scores:Object.fromEntries(Object.entries(S).map(([k,v])=>[labelMap[k],v])),
    raisons:Object.fromEntries(Object.entries(R).map(([k,v])=>[labelMap[k],[...new Set(v)].slice(0,3)])),
    confidence, effortTotal:effort, incentives
  };
}

// ========= UI =========
const pains=["Phishing","Fraude","Conformit√©","Acc√®s partag√©s","Sensibilisation","Gouvernance","Ransomware","Rotation personnel"]; 
const painsWrap=document.getElementById('pains');
let selectedPains=new Set();
function renderPainPills(){
  painsWrap.innerHTML='';
  pains.forEach(p=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='pill';
    btn.setAttribute('aria-pressed', selectedPains.has(p)?'true':'false');
    btn.setAttribute('aria-label', p);
    btn.textContent=p;
    btn.onclick=()=>{ if(selectedPains.has(p)) selectedPains.delete(p); else selectedPains.add(p); renderPainPills(); };
    btn.onkeydown=(e)=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); btn.click(); } };
    painsWrap.appendChild(btn);
  });
}
renderPainPills();

function val(id){return document.getElementById(id).value}
function ctxFromForm(){
  return {
    secteur: val('secteur'),
    tailleEntreprise: val('taille'),
    maturiteCyber: val('maturite'),
    budget: val('budget'),
    contraintesReglementaires: val('reg')==='Oui',
    multiSitesOuPrestataires: val('multi')==='Oui',
    painPoints: Array.from(selectedPains),
    filtrageMailExistant: val('filtre')==='Oui'
  };
}

function heatRow(score){
  // scale -10..+15 approx ‚Üí 0..5 cells
  const norm=Math.max(0,Math.min(5, Math.round((score+10)/5)));
  let html='<div class="heat">';
  for(let i=0;i<5;i++) html+=`<div class="cell" data-on="${i<norm?1:0}"></div>`;
  html+='</div>';
  return html;
}

function renderOutput(out){
  document.getElementById('kBundle').textContent=out.bundleCible;
  document.getElementById('kEffort').textContent=out.effortTotal.toFixed(1);
  document.getElementById('kConf').textContent=out.confidence+"%";
  document.getElementById('kIncent').textContent=out.incentives.length||'‚Äì';

  const rec=document.getElementById('recos');
  rec.innerHTML='';
  out.produitsRecommandes.forEach(p=>{
    const tag=document.createElement('div'); tag.className='tag'; tag.textContent=p; rec.appendChild(tag);
  });

  const scores=document.getElementById('scores');
  scores.innerHTML='';
  const entries=Object.entries(out.scores);
  entries.sort((a,b)=>b[1]-a[1]).forEach(([label,sc])=>{
    const it=document.createElement('div'); it.className='item';
    const reasons=(out.raisons[label]||[]).map(x=>`<span class="reason">${x}</span>`).join('');
    it.innerHTML=`
      <h3>${label} <span class="muted">‚Ä¢ score ${sc}</span></h3>
      <div class="scorebar"><span style="width:${Math.max(0,Math.min(100,(sc+10)*3))}%"></span></div>
      <div class="reasons">${reasons||'<span class="hint">Aucune raison enregistr√©e</span>'}</div>
      ${heatRow(sc)}
    `;
    scores.appendChild(it);
  });
}

function run(){
  const ctx=ctxFromForm();
  const out=scoreAndRecommend(ctx);
  renderOutput(out);
  window.__lastOut=out; // pour copie
}

function resetForm(){
  selectedPains.clear(); renderPainPills();
  document.getElementById('secteur').value='Sant√©';
  document.getElementById('taille').value='51-100';
  document.getElementById('maturite').value='Moyenne';
  document.getElementById('budget').value='Moyen';
  document.getElementById('reg').value='Oui';
  document.getElementById('multi').value='Oui';
  document.getElementById('filtre').value='Non';
  document.getElementById('recos').innerHTML='';
  document.getElementById('scores').innerHTML='';
  document.getElementById('kBundle').textContent='‚Äì';
  document.getElementById('kEffort').textContent='‚Äì';
  document.getElementById('kConf').textContent='‚Äì';
  document.getElementById('kIncent').textContent='‚Äì';
}

// Presets
function applyPreset(key){
  resetForm();
  if(key==='sante-mid'){
    document.getElementById('secteur').value='Sant√©';
    document.getElementById('taille').value='101-250';
    document.getElementById('maturite').value='Moyenne';
    document.getElementById('budget').value='Moyen';
    document.getElementById('reg').value='Oui';
    document.getElementById('multi').value='Oui';
    ['Phishing','Acc√®s partag√©s','Conformit√©'].forEach(p=>selectedPains.add(p));
    renderPainPills();
  }
  if(key==='industrie-pti'){
    document.getElementById('secteur').value='Industrie';
    document.getElementById('taille').value='11-50';
    document.getElementById('maturite').value='Faible';
    document.getElementById('budget').value='Faible';
    document.getElementById('reg').value='Non';
    document.getElementById('multi').value='Oui';
    ['Phishing','Acc√®s partag√©s'].forEach(p=>selectedPains.add(p));
    renderPainPills();
  }
  if(key==='public-large'){
    document.getElementById('secteur').value='Administration';
    document.getElementById('taille').value='1000+';
    document.getElementById('maturite').value='√âlev√©e';
    document.getElementById('budget').value='√âlev√©';
    document.getElementById('reg').value='Oui';
    document.getElementById('multi').value='Oui';
    ['Gouvernance','Sensibilisation'].forEach(p=>selectedPains.add(p));
    renderPainPills();
  }
}

// ====== Auto-tests (sanity) ======
function runSelfTests(){
  const out=document.getElementById('testsOut'); out.innerHTML='';
  const tests=[];
  // 1) Exclusivit√© Essential/Advanced
  const t1=scoreAndRecommend({secteur:'Industrie',tailleEntreprise:'11-50',maturiteCyber:'Faible',budget:'Faible',contraintesReglementaires:false,multiSitesOuPrestataires:false,painPoints:['Phishing'],filtrageMailExistant:false});
  tests.push({name:'Exclusivit√© Protect (‚â§50 ‚Üí Essential, pas Advanced)', pass: t1.produitsRecommandes.includes('Protect Essential') && !t1.produitsRecommandes.includes('Protect Advanced')});
  // 2) Filtrage existant retire Protect
  const t2=scoreAndRecommend({secteur:'Sant√©',tailleEntreprise:'101-250',maturiteCyber:'√âlev√©e',budget:'√âlev√©',contraintesReglementaires:true,multiSitesOuPrestataires:true,painPoints:['Gouvernance'],filtrageMailExistant:true});
  tests.push({name:'Filtrage existant ‚Üí pas de Protect', pass: !t2.produitsRecommandes.some(p=>p.startsWith('Protect'))});
  // 2b) Filtrage existant + human-only ‚áí Coach/Academy pr√©sents, aucun Protect
  const t2b=scoreAndRecommend({secteur:'√âducation',tailleEntreprise:'51-100',maturiteCyber:'Moyenne',budget:'Faible',contraintesReglementaires:true,multiSitesOuPrestataires:false,painPoints:['Sensibilisation','Conformit√©'],filtrageMailExistant:true});
  tests.push({name:'Filtrage existant + human-only ‚â•51 ‚Üí Coach (+Academy)', pass: t2b.produitsRecommandes.includes('Coach') && !t2b.produitsRecommandes.some(p=>p.startsWith('Protect'))});
  // 3) Sensibilisation only ‚â•51 force Coach+Academy
  const t3=scoreAndRecommend({secteur:'√âducation',tailleEntreprise:'101-250',maturiteCyber:'Moyenne',budget:'Moyen',contraintesReglementaires:true,multiSitesOuPrestataires:false,painPoints:['Sensibilisation','Conformit√©'],filtrageMailExistant:false});
  tests.push({name:'Sensibilisation-only ‚â•51 ‚Üí Coach + Academy', pass: t3.produitsRecommandes.includes('Coach') && t3.produitsRecommandes.includes('Cyber Academy')});
  // 4) Effort gating (1-50 ne doit pas d√©passer 2 produits)
  const t4=scoreAndRecommend({secteur:'Commerce',tailleEntreprise:'11-50',maturiteCyber:'Moyenne',budget:'Moyen',contraintesReglementaires:false,multiSitesOuPrestataires:true,painPoints:['Phishing','Acc√®s partag√©s','Fraude'],filtrageMailExistant:false});
  tests.push({name:'1-50 ‚Üí max 2 produits (plafond effort/budget)', pass: t4.produitsRecommandes.length<=2});
  // 5) 1000+ avec contraintes/budget √©lev√© peut aller √† 4 produits
  const t5=scoreAndRecommend({secteur:'Administration',tailleEntreprise:'1000+',maturiteCyber:'√âlev√©e',budget:'√âlev√©',contraintesReglementaires:true,multiSitesOuPrestataires:true,painPoints:['Gouvernance','Ransomware','Sensibilisation'],filtrageMailExistant:false});
  tests.push({name:'1000+ contraint/√âlev√© ‚Üí 3-4 produits possibles', pass: t5.produitsRecommandes.length>=3});

  // Render tests
  tests.forEach(t=>{
    const el=document.createElement('div'); el.className='test'; el.dataset.pass=t.pass; el.textContent=(t.pass?'‚úÖ ':'‚ùå ')+t.name; out.appendChild(el);
  });
}

// Wiring
 document.getElementById('run').onclick=run;
 document.getElementById('reset').onclick=resetForm;
 document.getElementById('copy').onclick=()=>{
   const data={input:ctxFromForm(), output: window.__lastOut||null};
   navigator.clipboard.writeText(JSON.stringify(data,null,2));
   alert('Copi√© dans le presse-papiers !');
 };
 document.querySelectorAll('[data-preset]').forEach(btn=>btn.addEventListener('click',e=>applyPreset(btn.dataset.preset)));
 document.getElementById('runTests').onclick=runSelfTests;

 // Boot (preset + premi√®re reco)
 applyPreset('sante-mid');
 run();
</script>
</body>
</html>
