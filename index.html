// Mailinblack – Scoring & Bundling Engine v2.3 (no U-Cyber)

type Secteur = "Santé"|"Industrie"|"Finance"|"Éducation"|"Administration"|"Commerce"|"BTP"|"Transport"|"Énergie"|"Autre";
type Taille = "1-10"|"11-50"|"51-100"|"101-250"|"250-1000"|"1000+";
type Maturite = "Faible"|"Moyenne"|"Élevée";
type Budget = "Faible"|"Moyen"|"Élevé";
type PainPoint = "Phishing"|"Fraude"|"Conformité"|"Accès partagés"|"Sensibilisation"|"Gouvernance"|"Ransomware"|"Rotation personnel";

export interface InputCtx {
  secteur: Secteur;
  tailleEntreprise: Taille;
  maturiteCyber: Maturite;
  budget: Budget;
  contraintesReglementaires: boolean;
  multiSitesOuPrestataires: boolean;
  painPoints: PainPoint[];
  filtrageMailExistant: boolean;
}

export interface Output {
  produitsRecommandes: string[];
  bundleCible: number;
  scores: Record<string, number>;
  raisons: Record<string, string[]>;
  confidence: number;
  effortTotal: number;
  incentives: string[];
}

const inArr = (arr: string[], ...vals: string[]) => vals.some(v => arr.includes(v));
const segOf = (t: Taille): "1-50"|"51-250"|"251-1000"|"1000+" => {
  if (t==="1-10"||t==="11-50") return "1-50";
  if (t==="51-100"||t==="101-250") return "51-250";
  if (t==="250-1000") return "251-1000";
  return "1000+";
};

const Effort = { Essential:0.5, Coach:0.5, Sikker:1.0, Advanced:1.5, Academy:1.0 };
const ThresholdEffort = { "1-50":2.0, "51-250":3.0, "251-1000":3.5, "1000+":3.5 };
const MaxProductsByBudget: Record<Budget, number> = { Faible:2, Moyen:3, Élevé:3 };
const BundleTargetBySeg = { "1-50":2, "51-250":3, "251-1000":3, "1000+":3 };

// --- Scorers
function scoreEssential(c: InputCtx){ let s=0, r:string[]=[];
  if (["1-10","11-50"].includes(c.tailleEntreprise)) { s+=3; r.push("Taille≤50"); }
  if (["BTP","Commerce","Transport","Industrie"].includes(c.secteur)) { s+=2; r.push("Secteur volume"); }
  if (c.maturiteCyber==="Faible") { s+=2; r.push("Maturité faible"); }
  if (c.budget==="Faible") { s+=2; r.push("Budget faible"); }
  if (inArr(c.painPoints,"Phishing","Fraude")) { s+=1; r.push("Phishing/Fraude"); }
  if (!c.multiSitesOuPrestataires) { s+=1; r.push("Mono-site"); }

  if (["101-250","250-1000","1000+"].includes(c.tailleEntreprise)) { s-=3; r.push("≥101: sous-dimensionné"); }
  if (c.maturiteCyber==="Élevée") { s-=2; r.push("Maturité élevée"); }
  if (c.contraintesReglementaires) { s-=1; r.push("Contraintes"); }
  if (c.contraintesReglementaires && ["51-100","101-250","250-1000","1000+"].includes(c.tailleEntreprise)) {
    s-=2; r.push("Réglementaire & ≥51");
  }
  if (c.filtrageMailExistant) { s-=3; r.push("Filtrage existant"); }

  const seg=segOf(c.tailleEntreprise);
  if (seg==="1-50") s+=1; if (seg==="251-1000") s-=1; if (seg==="1000+") s-=2;

  return {score:s, reasons:r};
}

function scoreAdvanced(c: InputCtx){ let s=0, r:string[]=[];
  if (["101-250","250-1000","1000+"].includes(c.tailleEntreprise)) { s+=3; r.push("Taille mid/large"); }
  if (["Santé","Finance","Éducation","Administration","Énergie"].includes(c.secteur)) { s+=3; r.push("Secteur critique"); }
  if (c.contraintesReglementaires) { s+=3; r.push("Contraintes"); }
  if (c.maturiteCyber==="Élevée") { s+=2; r.push("Maturité élevée"); }
  if (inArr(c.painPoints,"Gouvernance","Ransomware")) { s+=2; r.push("Gov/Ransomware"); }
  if (c.multiSitesOuPrestataires) { s+=1; r.push("Multi-sites"); }

  if (["1-10","11-50"].includes(c.tailleEntreprise)) { s-=3; r.push("≤50: surdimensionné"); }
  if (c.budget==="Faible") { s-=2; r.push("Budget faible"); }
  if (c.filtrageMailExistant) { s-=3; r.push("Filtrage existant"); }

  const seg=segOf(c.tailleEntreprise);
  if (seg==="51-250") s+=1; if (seg==="251-1000"||seg==="1000+") s+=2;
  if (c.secteur==="Finance") { s+=1; r.push("Finance:+1"); }

  return {score:s, reasons:r};
}

function scoreCoach(c: InputCtx){ let s=0, r:string[]=[];
  if (inArr(c.painPoints,"Phishing","Fraude","Sensibilisation")) { s+=3; r.push("Phishing/Fraude/Sensibilisation"); }
  if (c.contraintesReglementaires) { s+=3; r.push("Conformité"); }
  if (["Santé","Finance","Administration","Éducation","Commerce","BTP"].includes(c.secteur)) { s+=2; r.push("Secteur prioritaire"); }
  if (["Moyenne","Élevée"].includes(c.maturiteCyber)) { s+=2; r.push("Maturité ok"); }
  if (!["1-10"].includes(c.tailleEntreprise)) { s+=1; r.push("≥11 employés"); }
  if (c.budget==="Moyen") { s+=1; r.push("Budget moyen"); }
  if ((c.secteur==="BTP"||c.secteur==="Commerce") && ["1-10","11-50"].includes(c.tailleEntreprise)) { s+=1; r.push("PME terrain"); }
  if (c.filtrageMailExistant) { s+=1; r.push("Complément filtrage"); }
  if (c.budget==="Faible" && c.tailleEntreprise==="1-10" && !c.contraintesReglementaires) { s-=2; r.push("TPE budget faible"); }
  const seg=segOf(c.tailleEntreprise); if (seg==="51-250"||seg==="251-1000") s+=1;
  if (["Santé","Administration","Éducation"].includes(c.secteur)) s+=1;
  return {score:s, reasons:r};
}

function scoreSikker(c: InputCtx){ let s=0, r:string[]=[];
  if (c.multiSitesOuPrestataires) { s+=3; r.push("Multi-sites/Prestataires"); }
  if (inArr(c.painPoints,"Accès partagés","Rotation personnel")) { s+=3; r.push("Accès partagés/Rotation"); }
  if (["Industrie","Commerce","BTP","Éducation","Transport"].includes(c.secteur)) { s+=2; r.push("Secteur accès partagés"); }
  if (["1-10","11-50","51-100","101-250"].includes(c.tailleEntreprise)) { s+=2; r.push("≤250: IAM light"); }
  if (c.maturiteCyber==="Moyenne") { s+=1; r.push("Maturité moyenne"); }
  if (c.budget==="Faible") { s-=1; r.push("Budget faible"); }
  if (inArr(c.painPoints,"Gouvernance")) { s+=1; r.push("Gouvernance"); }
  if (c.tailleEntreprise==="1000+") { s-=2; r.push("1000+: IAM existant"); if (c.multiSitesOuPrestataires){ s+=2; r.push("Prestataires: ok"); } }
  const seg=segOf(c.tailleEntreprise); if (seg==="51-250"||seg==="251-1000") s+=2; if (seg==="1000+") s+=1;
  if (["Santé","Administration"].includes(c.secteur)) { s+=1; r.push("Santé/Public:+1"); }
  return {score:s, reasons:r};
}

function scoreAcademy(c: InputCtx){ let s=0, r:string[]=[];
  if (c.contraintesReglementaires) { s+=3; r.push("Conformité"); }
  if (["Finance","Santé","Éducation","Administration","Énergie"].includes(c.secteur)) { s+=3; r.push("Secteur régulé"); }
  if (["Moyenne","Élevée"].includes(c.maturiteCyber)) { s+=2; r.push("Maturité ok"); }
  if (!["1-10","11-50"].includes(c.tailleEntreprise)) { s+=2; r.push("≥51 employés"); }
  if (inArr(c.painPoints,"Conformité","Sensibilisation")) { s+=1; r.push("Conformité/Sensibilisation"); }
  if (c.filtrageMailExistant) { s+=1; r.push("Complément filtrage"); }
  if (c.secteur==="Éducation") { s+=1; r.push("Éducation:+1"); }
  if (c.tailleEntreprise==="1-10") { s-=2; r.push("TPE: chronophage"); }
  if (c.budget==="Faible") { s-=2; r.push("Budget faible"); }
  if ((c.secteur==="BTP"||c.secteur==="Commerce") && ["1-10","11-50"].includes(c.tailleEntreprise)) { s-=1; r.push("BTP/Commerce≤50"); }
  const seg=segOf(c.tailleEntreprise); if (seg!=="1-50") s+=1;
  if (["Santé","Administration"].includes(c.secteur)) s+=1;
  return {score:s, reasons:r};
}

// vertical tweaks (identiques à la version Notion)
function applyVerticalTweaks(S:any, R:any, c:InputCtx){
  if (["Santé","Administration"].includes(c.secteur)) {
    S.Coach+=1; R.Coach.push("Vertical:+1 Coach");
    S.Academy+=1; R.Academy.push("Vertical:+1 Academy");
    S.Sikker+=1; R.Sikker.push("Vertical:+1 Sikker");
  }
  if (c.secteur==="Industrie"){ S.Sikker+=2; R.Sikker.push("Industrie:+2"); S.Coach+=1; R.Coach.push("Industrie:+1"); }
  if (c.secteur==="Finance"){ S.Advanced+=1; R.Advanced.push("Finance:+1"); S.Coach+=1; R.Coach.push("Finance:+1"); S.Academy+=1; R.Academy.push("Finance:+1"); }
  if (c.secteur==="Éducation"){ S.Academy+=1; R.Academy.push("Éducation:+1"); S.Coach+=1; R.Coach.push("Éducation:+1"); }
  if (c.secteur==="BTP"||c.secteur==="Commerce"){ S.Academy-=1; R.Academy.push("BTP/Commerce:-1"); S.Coach+=1; R.Coach.push("BTP/Commerce:+1"); }
  if (c.secteur==="Énergie"){ S.Advanced+=1; R.Advanced.push("Énergie:+1"); S.Academy+=1; R.Academy.push("Énergie:+1"); }
}

function computeIncentives(c:InputCtx, produits:string[]){
  const seg=segOf(c.tailleEntreprise); const inc:string[]=[];
  const has=(p:string)=>produits.includes(p);
  if (seg==="1-50" && has("Essential") && has("Coach")) inc.push("Sikker 3 mois off si souscription <30j");
  if ((seg==="51-250"||seg==="251-1000") && produits.length>=3) inc.push("-10% global bundle");
  if (c.tailleEntreprise==="1000+" && has("Advanced") && has("Coach") && has("Academy")) inc.push("-8% multi-pays / -12% si ≥2000 licences");
  if (["Santé","Éducation"].includes(c.secteur)) inc.push("Academy 3 mois off (pilote)");
  if (c.filtrageMailExistant) inc.push("Coach + Academy à -15% (complément filtrage)");
  return inc;
}

export function scoreAndRecommend(input: InputCtx): Output {
  const c={...input}; const seg=segOf(c.tailleEntreprise); const bundleTarget=BundleTargetBySeg[seg];

  // scores bruts
  let S:any={Essential:0,Advanced:0,Coach:0,Sikker:0,Academy:0};
  let R:Record<string,string[]>={Essential:[],Advanced:[],Coach:[],Sikker:[],Academy:[]};
  ({score:S.Essential,reasons:R.Essential}=scoreEssential(c));
  ({score:S.Advanced,reasons:R.Advanced}=scoreAdvanced(c));
  ({score:S.Coach,reasons:R.Coach}=scoreCoach(c));
  ({score:S.Sikker,reasons:R.Sikker}=scoreSikker(c));
  ({score:S.Academy,reasons:R.Academy}=scoreAcademy(c));

  // tweaks verticaux
  applyVerticalTweaks(S,R,c);

  // filtrage existant d'abord
  let candidates=Object.keys(S);
  if (c.filtrageMailExistant){
    candidates=candidates.filter(p=>!["Essential","Advanced"].includes(p));
    R.Essential.push("Retiré: filtrage existant");
    R.Advanced.push("Retiré: filtrage existant");
  } else {
    // exclusivité Protect
    if (S.Advanced > S.Essential){
      candidates=candidates.filter(p=>p!=="Essential");
      R.Essential.push("Retiré: Advanced > Essential");
    } else {
      candidates=candidates.filter(p=>p!=="Advanced");
      R.Advanced.push("Retiré: Essential ≥ Advanced");
    }
  }

  // sensibilisation only
  const onlyHuman = c.painPoints.every(pp=>["Phishing","Fraude","Sensibilisation","Conformité"].includes(pp));
  if (onlyHuman){
    if (["1-10","11-50"].includes(c.tailleEntreprise)){
      if (!candidates.includes("Coach")) candidates.push("Coach");
      R.Coach.push("Forcé: Sensibilisation-only ≤50");
      if (c.contraintesReglementaires && !candidates.includes("Academy")){
        candidates.push("Academy"); R.Academy.push("Option: Réglementaire ≤50");
      }
    } else {
      if (!candidates.includes("Coach")) candidates.push("Coach");
      if (!candidates.includes("Academy")) candidates.push("Academy");
      R.Coach.push("Forcé: Sensibilisation-only ≥51");
      R.Academy.push("Forcé: Sensibilisation-only ≥51");
    }
  }

  // classement et sélection
  const ranked=candidates.map(p=>({p,s:S[p]})).sort((a,b)=>b.s-a.s);
  let selected=ranked.filter(x=>x.s>0).map(x=>x.p);

  // plafond budget
  let maxProducts=MaxProductsByBudget[c.budget];
  if (c.tailleEntreprise==="1000+" && c.contraintesReglementaires && c.budget==="Élevé") maxProducts=4;

  // viser bundle target mais respect budget
  const need=Math.min(bundleTarget,maxProducts);
  selected=ranked.filter(x=>selected.includes(x.p)).slice(0,need).map(x=>x.p);

  // effort gating
  const sumEff=(ls:string[])=>ls.reduce((a,p)=>a+(Effort as any)[p],0);
  let effort=sumEff(selected), thr=ThresholdEffort[seg];
  if (effort>thr){
    const withDelta=selected.map(p=>({p,delta:S[p]- (Effort as any)[p]})).sort((a,b)=>a.delta-b.delta);
    while (effort>thr && withDelta.length){
      const rm=withDelta.shift()!.p;
      selected=selected.filter(p=>p!==rm);
      effort=sumEff(selected);
      R[rm].push("Retiré: sur-effort");
    }
  }

  // confidence
  const topScores=ranked.map(r=>r.s); const top1=topScores[0]??0; const top2=topScores[1]??0;
  const gap=Math.max(0,Math.min(10,top1-top2));
  let confidence=Math.round(60*(gap/10)+40*(1-Math.min(1,(effort-thr>0?(effort-thr)/thr:0))));
  if (c.budget==="Faible" && selected.length>2) confidence-=10;
  confidence=Math.max(0,Math.min(100,confidence));

  // incentives
  const incentives=computeIncentives(c,selected);

  // mapping labels
  const labelMap:any={Essential:"Protect Essential", Advanced:"Protect Advanced", Coach:"Coach", Sikker:"Sikker", Academy:"Cyber Academy"};

  return {
    produitsRecommandes: selected.map(p=>labelMap[p]),
    bundleCible: bundleTarget,
    scores: Object.fromEntries(Object.entries(S).map(([k,v])=>[labelMap[k], v])),
    raisons: Object.fromEntries(Object.entries(R).map(([k,v])=>[labelMap[k], [...new Set(v)].slice(0,3)])),
    confidence,
    effortTotal: effort,
    incentives
  };
}
